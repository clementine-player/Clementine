name: all
on: [push]

jobs:
  build_focal_64:
    name: Build Ubuntu Focal 64-bit deb
    runs-on: ubuntu-18.04
    container:
      image: ubuntu:focal
    steps:
      - name: Install dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: >
          apt-get update && apt-get install -y
          cmake
          fakeroot
          gettext
          git
          libasound2-dev
          libboost-dev
          libboost-serialization-dev
          libcdio-cdda2
          libcdio-dev
          libchromaprint-dev
          libcrypto++-dev
          libdbus-1-dev
          libfftw3-dev
          libglew1.5-dev
          libgpod-dev
          libgstreamer-plugins-base1.0-dev
          libgstreamer1.0-dev
          liblastfm5-dev
          libmtp-dev
          libmygpo-qt-dev
          libplist-dev
          libprotobuf-dev
          libpulse-dev
          libqca-qt5-2-dev
          libqca-qt5-2-plugins
          libqt5x11extras5-dev
          libsparsehash-dev
          libsqlite3-dev
          libtag1-dev
          libusbmuxd-dev
          protobuf-compiler
          qtbase5-dev
          qttools5-dev-tools
          qttools5-dev
          ssh
      - uses: actions/checkout@v2
      - name: cmake
        working-directory: bin
        run : >
          cmake ..
          -DWITH_DEBIAN=ON
          -DDEB_ARCH=amd64
          -DDEB_DIST=focal
          -DFORCE_GIT_VERSION=
          -DENABLE_SPOTIFY_BLOB=OFF
      - name: make
        working-directory: bin
        run : make -j2 deb
      - uses: actions/upload-artifact@v2
        with:
          name: release_focal_64
          path: bin/clementine_*.deb

  build_mac:
    name: Build Mac DMG
    runs-on: macos-10.15
    steps:
      - name: Install dependencies
        run: >
          brew install
          boost
          chromaprint
          cmake
          cryptopp
          fftw
          glew
          glib
          google-sparsehash
          gst-libav
          gst-plugins-bad
          gst-plugins-base
          gst-plugins-good
          gst-plugins-ugly
          gstreamer
          pkgconfig
          protobuf
          protobuf-c
          qt
      - name: Install liblastfm
        run: brew install https://raw.githubusercontent.com/tomahawk-player/homebrew-tomahawkqt5/master/liblastfm.rb
      - name: Fix liblastfm includes
        run: ln -s /usr/local/include/lastfm /usr/local/include/lastfm5
      - uses: actions/checkout@v2
      - name: cmake
        env:
          PKG_CONFIG_PATH: /usr/local/lib/pkgconfig
          Qt5_DIR: /usr/local/opt/qt5/lib/cmake/Qt5
          Qt5LinguistTools_DIR: /usr/local/opt/qt5/lib/cmake/Qt5LinguistTools
          GST_SCANNER_PATH: /usr/local/opt/gstreamer/libexec/gstreamer-1.0/gst-plugin-scanner
          GST_PLUGIN_PATH: /usr/local/lib/gstreamer-1.0
        working-directory: bin
        run: >
          cmake ..
          -Wno-dev
          -DCMAKE_BUILD_TYPE=Release
          -DCMAKE_OSX_ARCHITECTURES=x86_64
          -DGETTEXT_MSGMERGE_EXECUTABLE=/usr/local/opt/gettext/bin/msgmerge
          -DGETTEXT_MSGFMT_EXECUTABLE=/usr/local/opt/gettext/bin/msgfmt
          -DGETTEXT_XGETTEXT_EXECUTABLE=/usr/local/opt/gettext/bin/xgettext
      - name: make
        working-directory: bin
        run: make -j2
      - name: Copy icon files and resources
        working-directory: bin
        run: make install
      - name: Build DMG
        working-directory: bin
        run: make dmg
      - uses: actions/upload-artifact@v2
        with:
          name: release_mac
          path: bin/clementine-*.dmg

